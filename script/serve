#!/usr/bin/env ruby

require 'rubygems'
require 'bundler/setup'
Bundler.require(:default, :development)

require_relative '../lib/paths'

def on_event
  system("#{Paths.Script}/build-primaries")
  system("rspec") unless ENV['SKIP_RSPEC']
end

listener = Listen.to('lib', 'assets', 'templates', 'spec', only: /\.(rb|js|json|png|css|sass|haml)$/) do |modified, added, removed|
  on_event
end

on_event
listener.start

app = Rack::Builder.new do
  use(Rack::StaticCache, urls: [ '/javascripts', '/stylesheets', '/topojson' ], root: Paths.Dist, versioning: false)
  use(Rack::TryStatic, root: Paths.Dist, urls: [ '/' ], try: [ '.html' ])

  run lambda { [ 404, { 'Content-Type' => 'text/html' }, [ 'Not Found' ]] }
end

Rack::Server.start(app: app, Port: 3000) # will return after Ctrl+C

listener.stop

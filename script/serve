#!/usr/bin/env ruby

require 'rubygems'
require 'bundler/setup'
Bundler.require(:default, :development)

require_relative '../lib/paths'

def on_event
  system("#{Paths.Script}/build-primaries")
  system("rspec") unless ENV['SKIP_RSPEC']
end

listener = Listen.to('lib', 'assets', 'templates', 'spec', only: /\.(rb|js|json|png|css|sass|haml)$/) do |modified, added, removed|
  on_event
end

on_event
listener.start

app = Rack::Builder.new do
  use(Rack::TryStatic, root: Paths.Dist, urls: [ '/2016/primaries' ], try: [ '.html' ])
  use(Rack::Static,
      urls: [ '/2016' ],
      root: Paths.Dist,
      header_rules: [
        [ :all, { 'Cache-Control' => 'public, max-age=31536000', 'Expires' => (Time.now + 86400 * 365).utc.rfc2822 }],
        [ %w(css), { 'Content-Type' => 'text/css; charset=utf-8' } ],
        [ %w(js), { 'Content-Type' => 'application/javascript; charset=utf-8' } ],
        [ %w(json), { 'Content-Type' => 'application/json' } ]
      ]
  )

  run lambda { [ 404, { 'Content-Type' => 'text/html' }, [ 'Not Found' ]] }
end

Rack::Server.start(app: app, Port: 3000) # will return after Ctrl+C

listener.stop
